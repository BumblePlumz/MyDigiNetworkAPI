pipeline {
    agent {
        docker {
            image 'node:22.21.1-bookworm'
            args '-v /var/run/docker.sock:/var/run/docker.sock'
        }
    }

    environment {
        DOCKER_IMAGE = 'ghcr.io/bumbleplumz/mydiginetworkapi'
        GITHUB_REGISTRY = 'ghcr.io'
        GITHUB_REPO = 'BumblePlumz/MyDigiNetworkAPI'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        LATEST_TAG = 'latest'
    }

    stages {
        stage("Checkout") {
            steps {
                echo "üì• Cloning repository..."
                checkout scmGit(
                    branches: [[name: '*/main']], 
                    extensions: [], 
                    userRemoteConfigs: [[
                        credentialsId: 'bumble-jenkins-token', 
                        url: 'https://github.com/BumblePlumz/MyDigiNetworkAPI.git'
                    ]]
                )
            }
        }

        stage("Install Dependencies") {
            steps {
                echo "üì¶ Installing dependencies..."
                sh 'npm ci'
            }
        }

        stage("Verify Project Structure") {
            steps {
                echo "üîç Checking project structure..."
                sh '''
                    echo "Project files:"
                    ls -la
                    
                    echo "Node version:"
                    node --version
                    
                    echo "NPM version:"
                    npm --version
                    
                    echo "‚úÖ Project structure verified"
                '''
            }
        }

        stage("Run Tests") {
            steps {
                echo "üß™ Running unit tests..."
                sh 'npm run test:ci'
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'coverage',
                        reportFiles: 'index.html',
                        reportName: 'Coverage Report'
                    ])
                }
                success {
                    echo "‚úÖ Tests passed successfully!"
                }
                failure {
                    echo "‚ùå Tests failed!"
                }
            }
        }

        stage("Build Docker Image") {
            steps {
                script {
                    echo "üê≥ Building Docker image..."
                    echo "Image: ${DOCKER_IMAGE}:${IMAGE_TAG}"
                    
                    sh """
                        docker build -t ${DOCKER_IMAGE}:${IMAGE_TAG} \
                                     -t ${DOCKER_IMAGE}:${LATEST_TAG} \
                                     -t ${DOCKER_IMAGE}:${env.GIT_COMMIT[0..6]} \
                                     --build-arg BUILD_NUMBER=${env.BUILD_NUMBER} \
                                     --build-arg GIT_COMMIT=${env.GIT_COMMIT[0..6]} \
                                     .
                        
                        echo "‚úÖ Docker image built successfully"
                        docker images | grep mydiginetworkapi
                    """
                }
            }
        }

        stage("Tag Repository") {
            when {
                branch 'main'
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    def tagName = "v1.0.${env.BUILD_NUMBER}"
                    
                    echo "üè∑Ô∏è  Creating Git tag: ${tagName}"
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'efabefe9-b7dd-477c-afec-b748dd7e60a5',
                        usernameVariable: 'GIT_USERNAME',
                        passwordVariable: 'GIT_PASSWORD'
                    )]) {
                        sh """
                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@ci.local"
                            
                            git tag -a ${tagName} -m "Release v1.0.${env.BUILD_NUMBER}
                            
                            Build Information:
                            - Build Number: #${env.BUILD_NUMBER}
                            - Commit: ${env.GIT_COMMIT[0..6]}
                            - Date: \$(date '+%Y-%m-%d %H:%M:%S')
                            - Tests: ‚úÖ Passed
                            - Docker Image: ${DOCKER_IMAGE}:${IMAGE_TAG}
                            - Status: Ready for deployment üöÄ"
                            
                            git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/${GITHUB_REPO}.git ${tagName}
                        """
                    }
                    
                    echo "‚úÖ Tag ${tagName} created and pushed successfully!"
                }
            }
        }

        stage("Push to GitHub Packages") {
            when {
                branch 'main'
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    echo "üì§ Pushing Docker image to GitHub Container Registry..."
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'efabefe9-b7dd-477c-afec-b748dd7e60a5',
                        usernameVariable: 'GITHUB_USERNAME',
                        passwordVariable: 'GITHUB_TOKEN'
                    )]) {
                        sh """
                            echo ${GITHUB_TOKEN} | docker login ${GITHUB_REGISTRY} -u ${GITHUB_USERNAME} --password-stdin
                            
                            echo "Pushing ${DOCKER_IMAGE}:${IMAGE_TAG}..."
                            docker push ${DOCKER_IMAGE}:${IMAGE_TAG}
                            
                            echo "Pushing ${DOCKER_IMAGE}:${LATEST_TAG}..."
                            docker push ${DOCKER_IMAGE}:${LATEST_TAG}
                            
                            echo "Pushing ${DOCKER_IMAGE}:${env.GIT_COMMIT[0..6]}..."
                            docker push ${DOCKER_IMAGE}:${env.GIT_COMMIT[0..6]}
                            
                            docker logout ${GITHUB_REGISTRY}
                            
                            echo "‚úÖ Docker images pushed successfully to GitHub Packages!"
                            echo "üì¶ Available at: https://github.com/${GITHUB_REPO}/pkgs/container/mydiginetworkapi"
                        """
                    }
                }
            }
        }

        stage("Deploy") {
            when {
                branch 'main'
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    echo "üöÄ Deploying Docker image..."
                    
                    sh """
                        echo "Stopping old container if exists..."
                        docker stop social-network-api || true
                        docker rm social-network-api || true
                        
                        echo "Starting new container..."
                        docker run -d \
                            --name social-network-api \
                            -p 3000:3000 \
                            -e NODE_ENV=production \
                            ${DOCKER_IMAGE}:${IMAGE_TAG}
                        
                        echo "‚úÖ Application deployed successfully!"
                        echo "üåê Available at: http://localhost:3000"
                        
                        sleep 2
                        docker ps | grep social-network-api
                    """
                }
            }
        }

        stage("Verify Deployment") {
            when {
                branch 'main'
            }
            steps {
                script {
                    echo "‚úÖ Verifying deployment..."
                    sh """
                        sleep 5
                        
                        docker ps -a | grep social-network-api
                        
                        echo "Container logs:"
                        docker logs social-network-api --tail 20
                        
                        echo "‚úÖ Deployment verified!"
                    """
                }
            }
        }

        stage("Cleanup") {
            steps {
                script {
                    echo "üßπ Cleaning up old Docker images..."
                    sh '''
                        docker system prune -f --filter "until=72h" || true
                        echo "‚úÖ Cleanup completed!"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "üèÅ Pipeline completed."
        }
        success {
            echo """
            ‚úÖ ============================================
            ‚úÖ Pipeline succeeded! üéâ
            ‚úÖ ============================================
            
            üì¶ Docker Image: ${DOCKER_IMAGE}:${IMAGE_TAG}
            üè∑Ô∏è  Git Tag: v1.0.${env.BUILD_NUMBER}
            üì§ GitHub Package: https://github.com/${GITHUB_REPO}/pkgs/container/mydiginetworkapi
            üåê Application: http://localhost:3000
            
            ‚úÖ ============================================
            """
        }
        failure {
            echo """
            ‚ùå ============================================
            ‚ùå Pipeline failed! 
            ‚ùå ============================================
            
            Check the logs above for details.
            """
        }
    }
}